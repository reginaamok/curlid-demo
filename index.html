<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Curl.ID AI</title>

  <!-- TFJS + Teachable Machine Image -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

  <style>
    body{
      font-family: Arial, sans-serif;
      background:#8ecae6;
      margin:0;
      padding:40px 16px;
      display:flex;
      justify-content:center;
    }
    .card{
      background:#fff;
      width:min(820px, 100%);
      border-radius:24px;
      padding:28px;
      box-shadow: 0 8px 20px rgba(0,0,0,.12);
    }
    h1{ margin:0 0 8px; text-align:center; }
    .sub{ text-align:center; margin:0 0 18px; opacity:.8; }
    .row{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
    input[type="file"]{ padding:10px; }
    button{
      padding:10px 18px;
      border:none;
      border-radius:12px;
      cursor:pointer;
      background:#5a4635;
      color:#fff;
      font-weight:700;
    }
    .result{
      margin-top:18px;
      padding:14px;
      border-radius:14px;
      background:#f7f7f7;
    }
    .small{ font-size:13px; opacity:.8; }
    .bars{ margin-top:10px; }
    .barRow{ display:flex; align-items:center; gap:10px; margin:8px 0; }
    .label{ width:160px; font-weight:700; }
    .barWrap{ flex:1; background:#e9e9e9; height:12px; border-radius:999px; overflow:hidden; }
    .bar{ height:100%; width:0%; background:#5a4635; }
    .prod{ margin-top:12px; }
    .prod li{ margin:10px 0; }
    .prod .why{ font-size:14px; opacity:.9; margin-top:2px; }
    img.preview{
      max-width:220px;
      border-radius:14px;
      display:block;
      margin:14px auto 0;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>Curl.ID AI</h1>
    <p class="sub">Upload a hair photo â€” the model will classify your hair family and show product ideas + why they help.</p>

    <div class="row">
      <input id="photo" type="file" accept="image/*" />
      <button onclick="analyze()">Analyze</button>
    </div>

    <img id="preview" class="preview" alt="" style="display:none;" />

    <div id="status" class="small" style="text-align:center; margin-top:10px;"></div>
    <div id="result" class="result" style="display:none;"></div>
  </div>

<script>
  // ===== Product recommendations + WHY =====
  const PRODUCT_RECS = {
    "Straight (1Aâ€“1C)": [
      { name:"Lightweight Volumizing Shampoo", why:"Straight hair can get oily/flat fastâ€”light formulas clean without weighing it down." },
      { name:"Dry Shampoo", why:"Absorbs oil at the roots to keep straight hair fresh between washes." },
      { name:"Heat Protectant Spray", why:"Straight hair is often heat-styled; protectant helps prevent damage and split ends." },
    ],
    "Wavy (2Aâ€“2C)": [
      { name:"Light Curl Cream / Wave Enhancer", why:"Defines waves and reduces frizz without making hair crunchy or heavy." },
      { name:"Lightweight Leave-In Conditioner", why:"Adds moisture to fight frizz while keeping waves bouncy." },
      { name:"Microfiber Towel / Cotton T-Shirt", why:"Less friction than a regular towel = less frizz + better wave clumps." },
    ],
    "Curly (3Aâ€“3C)": [
      { name:"Curl Defining Cream", why:"Curly hair needs definition + moisture to keep curls shaped and less frizzy." },
      { name:"Deep Conditioner / Hair Mask", why:"Curls dry out faster; deep conditioning helps softness, shine, and breakage control." },
      { name:"Gel (medium hold)", why:"Creates a light â€˜castâ€™ that locks curl shape and helps curls last longer." },
    ],
    "Coily (4Aâ€“4C)": [
      { name:"Rich Leave-In Conditioner", why:"Coily hair needs more moisture; leave-in helps prevent dryness and shrinkage frizz." },
      { name:"Hair Butter / Thick Cream", why:"Seals moisture and adds long-lasting softness for tighter curl patterns." },
      { name:"Oil (jojoba/castor) for sealing", why:"Helps lock moisture in and reduces breakage at the ends." },
    ],
  };

  // ===== Teachable Machine model loader =====
  // Your files are in repo root, so this works:
  const MODEL_URL = "./model.json";
  const METADATA_URL = "./metadata.json";
  let model = null;
  let maxPredictions = 0;

  async function ensureModelLoaded(){
    if (model) return;
    document.getElementById("status").textContent = "Loading AI model...";
    model = await tmImage.load(MODEL_URL, METADATA_URL);
    maxPredictions = model.getTotalClasses();
    document.getElementById("status").textContent = "Model loaded âœ… Upload a photo and click Analyze.";
  }

  function hairFamilyFromLabel(label){
    const t = String(label || "").toLowerCase();
    // Match your class names (example: "Wavy (2Aâ€“2C)", "Staright 1A-1C", etc.)
    if (t.includes("straight") || t.includes("staright") || t.includes("1a")) return "Straight (1Aâ€“1C)";
    if (t.includes("wavy") || t.includes("2a")) return "Wavy (2Aâ€“2C)";
    if (t.includes("curly") || t.includes("3a")) return "Curly (3Aâ€“3C)";
    if (t.includes("coily") || t.includes("4a")) return "Coily (4Aâ€“4C)";
    return null;
  }

  function pct(n){ return Math.round(n * 100); }

  async function analyze(){
    await ensureModelLoaded();

    const fileInput = document.getElementById("photo");
    const resultEl = document.getElementById("result");
    const previewEl = document.getElementById("preview");

    if (!fileInput.files || fileInput.files.length === 0){
      document.getElementById("status").textContent = "Please choose a photo first ðŸ™‚";
      return;
    }

    // Show preview
    const file = fileInput.files[0];
    const url = URL.createObjectURL(file);
    previewEl.src = url;
    previewEl.style.display = "block";

    document.getElementById("status").textContent = "Analyzingâ€¦";
    resultEl.style.display = "none";

    // Create image element to predict
    const img = new Image();
    img.src = url;
    await new Promise((res, rej) => { img.onload = res; img.onerror = rej; });

    const predictions = await model.predict(img);

    // Sort best first
    predictions.sort((a,b) => b.probability - a.probability);
    const top = predictions[0];

    const family = hairFamilyFromLabel(top.className) || top.className;
    const products = PRODUCT_RECS[family] || [];

    // Build prediction bars
    const bars = predictions.map(p => `
      <div class="barRow">
        <div class="label">${p.className}</div>
        <div class="barWrap"><div class="bar" style="width:${pct(p.probability)}%"></div></div>
        <div style="width:52px; text-align:right;">${pct(p.probability)}%</div>
      </div>
    `).join("");

    // Build products list
    const prodHTML = products.length ? `
      <div class="prod">
        <div style="font-weight:700; margin-top:10px;">Recommended products (and why):</div>
        <ol>
          ${products.map(p => `
            <li>
              <div style="font-weight:700;">${p.name}</div>
              <div class="why">${p.why}</div>
            </li>
          `).join("")}
        </ol>
      </div>
    ` : `<div class="small" style="margin-top:10px;">No product list found for this label yet.</div>`;

    resultEl.innerHTML = `
      <div style="text-align:center;">
        <div style="font-size:22px; font-weight:800;">Result: ${top.className}</div>
        <div style="margin-top:6px; font-weight:700;">Confidence: ${pct(top.probability)}%</div>
        <div style="margin-top:6px; font-weight:700;">Hair family: ${family}</div>
      </div>

      <div class="bars">${bars}</div>

      ${prodHTML}

      <div class="small" style="margin-top:12px;">
        Tip: Use bright natural light and show your full curl/wave pattern for best results.
      </div>
    `;

    resultEl.style.display = "block";
    document.getElementById("status").textContent = "Done âœ…";
  }

  // Load model as soon as page opens
  ensureModelLoaded();
</script>
</body>
</html>
